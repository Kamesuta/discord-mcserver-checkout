// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "mysql"
}

enum WorkflowStatus {
  /// 承認待ち
  PENDING
  /// 却下
  REJECTED
  /// 貸出中（サーバー割り当て済み）
  ACTIVE
  /// 返却済み
  RETURNED
}

/// 申請情報を管理するテーブル
/// id は バックアップ保存先パスの識別子としても使用される
model Workflow {
  /// ワークフロー ID（バックアップ命名にも使用）
  id                 Int            @id @default(autoincrement())
  /// 申請ステータス
  status             WorkflowStatus @default(PENDING)
  /// サーバーの説明/用途（企画名）
  description        String
  /// 申請者の Discord ユーザーID
  applicantDiscordId String
  /// 主催者の Discord ユーザーID
  organizerDiscordId String
  /// 希望 Minecraft バージョン
  mcVersion          String
  /// 貸出希望期間（日数）
  periodDays         Int
  /// Pterodactyl サーバーID（割り当て後に埋まる）
  pteroServerId      String?
  /// 貸出開始日（割り当て後に埋まる）
  startDate          DateTime?
  /// 貸出終了日（割り当て後に埋まる）
  endDate            DateTime?
  /// 作成日時
  createdAt          DateTime       @default(now())
  /// 更新日時
  updatedAt          DateTime       @updatedAt

  /// パネル権限付与対象ユーザー一覧
  panelUsers WorkflowPanelUser[]
}

/// 申請ごとのパネル権限付与対象ユーザー
/// 1つの申請に複数のユーザーが対応する
/// PterodactylUser への FK を持たない（申請時点で未登録の場合がある）
model WorkflowPanelUser {
  /// 主キー
  id         Int    @id @default(autoincrement())
  /// ワークフロー ID
  workflowId Int
  /// パネル権限付与対象ユーザーの Discord ユーザーID
  discordId  String

  /// Workflow への関連
  workflow Workflow @relation(fields: [workflowId], references: [id])
}

/// Discord ユーザーと Pterodactyl ユーザーの対応付け
/// 承認フローで初回登録時に作成され、以降の申請で再利用される
model PterodactylUser {
  /// Discord ユーザーID（主キー）
  discordId String   @id
  /// Pterodactyl ユーザー名
  username  String   @unique
  /// メールアドレス (username@kpw.local)
  email     String   @unique
  /// 登録日時
  createdAt DateTime @default(now())
}

/// サーバーエイリアスとPterodactyl IDの対応付けを管理
model ServerBinding {
  /// エイリアス (例: server01, server02)
  name      String   @id
  /// Pterodactyl サーバーID (例: 354dc039)
  pteroId   String
  /// 作成日時
  createdAt DateTime @default(now())
  /// 更新日時
  updatedAt DateTime @updatedAt
}
